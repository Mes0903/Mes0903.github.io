<!doctype html>
<html lang="en-US" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.19" />
    <meta name="theme" content="VuePress Theme Hope 2.0.0-rc.71" />
    <style>
      :root {
        --vp-c-bg: #fff;
      }

      [data-theme="dark"] {
        --vp-c-bg: #1b1b1f;
      }

      html,
      body {
        background: var(--vp-c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    </script>
    <meta property="og:url" content="https://mes0903.github.io/Cpp-Miner/Miner_BlackMagic/Indirect_through_null_pointer/"><meta property="og:site_name" content="Mes's Blog"><meta property="og:title" content="礦坑系列 ── Indirect through null pointer"><meta property="og:description" content="礦坑系列首頁：首頁 hackmd 版首頁：首頁 前言 事情起於 jserv 的講義裡面有個 &((data*)0)->c) 這樣的操作，作用是求 c 在 data 這個 struct 中的偏移量，但那個 0 實在是讓我覺得很不順眼，為了確定他到底是不是 UB，我翻了一個多禮拜的 standard 與 committee paper，甚至翻了 CWG i..."><meta property="og:type" content="article"><meta property="og:locale" content="en-US"><meta property="article:tag" content="C++ Miner-BlackMagic"><meta property="article:published_time" content="2023-08-12T00:00:00.000Z"><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"礦坑系列 ── Indirect through null pointer","image":[""],"datePublished":"2023-08-12T00:00:00.000Z","dateModified":null,"author":[{"@type":"Person","name":"Mes","url":"https://mes0903.github.io"}]}</script><link rel="icon" href="/flame.ico"><title>礦坑系列 ── Indirect through null pointer | Mes's Blog</title><meta name="description" content="礦坑系列首頁：首頁 hackmd 版首頁：首頁 前言 事情起於 jserv 的講義裡面有個 &((data*)0)->c) 這樣的操作，作用是求 c 在 data 這個 struct 中的偏移量，但那個 0 實在是讓我覺得很不順眼，為了確定他到底是不是 UB，我翻了一個多禮拜的 standard 與 committee paper，甚至翻了 CWG i...">
    <link rel="preload" href="/assets/style-DW1OEkiQ.css" as="style"><link rel="stylesheet" href="/assets/style-DW1OEkiQ.css">
    <link rel="modulepreload" href="/assets/app-BcP8o8U4.js"><link rel="modulepreload" href="/assets/index.html-b5wTyc_O.js"><link rel="modulepreload" href="/assets/plugin-vue_export-helper-DlAUqK2U.js">
    <link rel="prefetch" href="/assets/index.html-BiEWK1GR.js" as="script"><link rel="prefetch" href="/assets/index.html-B_H8OoE4.js" as="script"><link rel="prefetch" href="/assets/index.html-B6QgGw1I.js" as="script"><link rel="prefetch" href="/assets/index.html-CfApM9ED.js" as="script"><link rel="prefetch" href="/assets/index.html-CsGh_Sko.js" as="script"><link rel="prefetch" href="/assets/index.html-CackVi67.js" as="script"><link rel="prefetch" href="/assets/index.html-ZJwihc1a.js" as="script"><link rel="prefetch" href="/assets/index.html-BLPTrtIz.js" as="script"><link rel="prefetch" href="/assets/index.html-BkR214TD.js" as="script"><link rel="prefetch" href="/assets/index.html-SiEU4OdJ.js" as="script"><link rel="prefetch" href="/assets/index.html-BvIw9pTT.js" as="script"><link rel="prefetch" href="/assets/index.html-BnqPezdy.js" as="script"><link rel="prefetch" href="/assets/index.html-C2EEiO23.js" as="script"><link rel="prefetch" href="/assets/AboutMovingForward.html-BVXUatD0.js" as="script"><link rel="prefetch" href="/assets/RasterI.html-DZu6U60_.js" as="script"><link rel="prefetch" href="/assets/index.html-BnPU3ndH.js" as="script"><link rel="prefetch" href="/assets/index.html-CDWGPQj5.js" as="script"><link rel="prefetch" href="/assets/index.html-BZAA8teD.js" as="script"><link rel="prefetch" href="/assets/index.html-B29x6D-I.js" as="script"><link rel="prefetch" href="/assets/index.html-d9TxGGlK.js" as="script"><link rel="prefetch" href="/assets/index.html-x0TChf0P.js" as="script"><link rel="prefetch" href="/assets/index.html-RUmwL0vR.js" as="script"><link rel="prefetch" href="/assets/index.html-DiP1_nrU.js" as="script"><link rel="prefetch" href="/assets/index.html-CWhwJJRF.js" as="script"><link rel="prefetch" href="/assets/index.html-DUBF5UHc.js" as="script"><link rel="prefetch" href="/assets/index.html-B1-KcoWy.js" as="script"><link rel="prefetch" href="/assets/index.html-DjRvgdxh.js" as="script"><link rel="prefetch" href="/assets/risc-v_osdi.html-CF5-ccKo.js" as="script"><link rel="prefetch" href="/assets/index.html-ogpKYtWm.js" as="script"><link rel="prefetch" href="/assets/index.html-CLdwlagL.js" as="script"><link rel="prefetch" href="/assets/index.html-DsRYPjK6.js" as="script"><link rel="prefetch" href="/assets/index.html-BcHUWuuC.js" as="script"><link rel="prefetch" href="/assets/index.html-CFCnu_oK.js" as="script"><link rel="prefetch" href="/assets/index.html-CfBwqcOE.js" as="script"><link rel="prefetch" href="/assets/index.html-BJxZQvsX.js" as="script"><link rel="prefetch" href="/assets/index.html-DM0Dryhz.js" as="script"><link rel="prefetch" href="/assets/index.html-Bdi3atey.js" as="script"><link rel="prefetch" href="/assets/index.html-Db6XWDF4.js" as="script"><link rel="prefetch" href="/assets/index.html-BIMDrBZh.js" as="script"><link rel="prefetch" href="/assets/index.html-1WitTtjF.js" as="script"><link rel="prefetch" href="/assets/index.html-BBc1mo51.js" as="script"><link rel="prefetch" href="/assets/index.html-Da_dn3sB.js" as="script"><link rel="prefetch" href="/assets/index.html-bcnvj3fg.js" as="script"><link rel="prefetch" href="/assets/index.html-DBjWceTq.js" as="script"><link rel="prefetch" href="/assets/index.html-CYG3E7BE.js" as="script"><link rel="prefetch" href="/assets/index.html-Byh5ax_b.js" as="script"><link rel="prefetch" href="/assets/index.html-CPX4-oWw.js" as="script"><link rel="prefetch" href="/assets/404.html-CH4Ibaef.js" as="script"><link rel="prefetch" href="/assets/index.html-728yCafu.js" as="script"><link rel="prefetch" href="/assets/index.html-lyIe0CpS.js" as="script"><link rel="prefetch" href="/assets/index.html-Wzc89aeg.js" as="script"><link rel="prefetch" href="/assets/index.html-EsIA7Wqr.js" as="script"><link rel="prefetch" href="/assets/index.html-CRq7Djss.js" as="script"><link rel="prefetch" href="/assets/index.html-BNg86-sq.js" as="script"><link rel="prefetch" href="/assets/index.html-BuPK7MMf.js" as="script"><link rel="prefetch" href="/assets/index.html-CXd-1WE2.js" as="script"><link rel="prefetch" href="/assets/index.html-BPYKVIQl.js" as="script"><link rel="prefetch" href="/assets/index.html-Du47nPb9.js" as="script"><link rel="prefetch" href="/assets/index.html-BcGBAPVR.js" as="script"><link rel="prefetch" href="/assets/index.html-Bz_MoDKk.js" as="script"><link rel="prefetch" href="/assets/index.html-Cy6boZwT.js" as="script"><link rel="prefetch" href="/assets/index.html-Bgc2pn_w.js" as="script"><link rel="prefetch" href="/assets/index.html-Dqr7MINQ.js" as="script"><link rel="prefetch" href="/assets/index.html-B_kkQH4U.js" as="script"><link rel="prefetch" href="/assets/index.html-BrdzQkpQ.js" as="script"><link rel="prefetch" href="/assets/index.html-Blq7aT-q.js" as="script"><link rel="prefetch" href="/assets/index.html-axLJhkf5.js" as="script"><link rel="prefetch" href="/assets/index.html-DBWaheD3.js" as="script"><link rel="prefetch" href="/assets/index.html-DGxj-483.js" as="script"><link rel="prefetch" href="/assets/index.html-CarUXHpG.js" as="script"><link rel="prefetch" href="/assets/index.html-BHE8pNse.js" as="script"><link rel="prefetch" href="/assets/index.html-Dd-niVBl.js" as="script"><link rel="prefetch" href="/assets/index.html-BM7yhHKu.js" as="script"><link rel="prefetch" href="/assets/index.html-DL9y76Vc.js" as="script"><link rel="prefetch" href="/assets/index.html-DJXfLGA7.js" as="script"><link rel="prefetch" href="/assets/photoswipe.esm-DXWKOczD.js" as="script"><link rel="prefetch" href="/assets/index-B-M8YVCw.js" as="script"><link rel="prefetch" href="/assets/setupDevtools-7MC2TMWH-slnMg1Ma.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="vp-skip-link sr-only">Skip to main content</a><!--]--><!--[--><div class="theme-container no-sidebar external-link-icon has-toc" vp-container><!--[--><header id="navbar" class="vp-navbar" vp-navbar><div class="vp-navbar-start"><button type="button" class="vp-toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!--[--><a class="route-link vp-brand" href="/" aria-label="Take me home"><img class="vp-nav-logo" src="/flame.jpg" alt><!----><span class="vp-site-name hide-in-pad">Mes&#39;s Blog</span></a><!--]--></div><div class="vp-navbar-center"><!--[--><!----><!--]--></div><div class="vp-navbar-end"><!--[--><!----><!----><div class="vp-nav-item hide-in-mobile"><button type="button" class="vp-color-mode-switch" id="color-mode-switch"><svg xmlns="http://www.w3.org/2000/svg" class="icon auto-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="auto icon" name="auto" style="display:block;"><path d="M512 992C246.92 992 32 777.08 32 512S246.92 32 512 32s480 214.92 480 480-214.92 480-480 480zm0-840c-198.78 0-360 161.22-360 360 0 198.84 161.22 360 360 360s360-161.16 360-360c0-198.78-161.22-360-360-360zm0 660V212c165.72 0 300 134.34 300 300 0 165.72-134.28 300-300 300z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon dark-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="dark icon" name="dark" style="display:none;"><path d="M524.8 938.667h-4.267a439.893 439.893 0 0 1-313.173-134.4 446.293 446.293 0 0 1-11.093-597.334A432.213 432.213 0 0 1 366.933 90.027a42.667 42.667 0 0 1 45.227 9.386 42.667 42.667 0 0 1 10.24 42.667 358.4 358.4 0 0 0 82.773 375.893 361.387 361.387 0 0 0 376.747 82.774 42.667 42.667 0 0 1 54.187 55.04 433.493 433.493 0 0 1-99.84 154.88 438.613 438.613 0 0 1-311.467 128z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon light-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="light icon" name="light" style="display:none;"><path d="M952 552h-80a40 40 0 0 1 0-80h80a40 40 0 0 1 0 80zM801.88 280.08a41 41 0 0 1-57.96-57.96l57.96-58a41.04 41.04 0 0 1 58 58l-58 57.96zM512 752a240 240 0 1 1 0-480 240 240 0 0 1 0 480zm0-560a40 40 0 0 1-40-40V72a40 40 0 0 1 80 0v80a40 40 0 0 1-40 40zm-289.88 88.08-58-57.96a41.04 41.04 0 0 1 58-58l57.96 58a41 41 0 0 1-57.96 57.96zM192 512a40 40 0 0 1-40 40H72a40 40 0 0 1 0-80h80a40 40 0 0 1 40 40zm30.12 231.92a41 41 0 0 1 57.96 57.96l-57.96 58a41.04 41.04 0 0 1-58-58l58-57.96zM512 832a40 40 0 0 1 40 40v80a40 40 0 0 1-80 0v-80a40 40 0 0 1 40-40zm289.88-88.08 58 57.96a41.04 41.04 0 0 1-58 58l-57.96-58a41 41 0 0 1 57.96-57.96z"></path></svg></button></div><!--[--><div id="docsearch-container" style="display:none;"></div><div><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"><kbd class="DocSearch-Button-Key"><svg width="15" height="15" class="DocSearch-Control-Key-Icon"><path d="M4.505 4.496h2M5.505 5.496v5M8.216 4.496l.055 5.993M10 7.5c.333.333.5.667.5 1v2M12.326 4.5v5.996M8.384 4.496c1.674 0 2.116 0 2.116 1.5s-.442 1.5-2.116 1.5M3.205 9.303c-.09.448-.277 1.21-1.241 1.203C1 10.5.5 9.513.5 8V7c0-1.57.5-2.5 1.464-2.494.964.006 1.134.598 1.24 1.342M12.553 10.5h1.953" stroke-width="1.2" stroke="currentColor" fill="none" stroke-linecap="square"></path></svg></kbd><kbd class="DocSearch-Button-Key">K</kbd></span></button></div><!--]--><!--]--><button type="button" class="vp-toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span><span class="vp-top"></span><span class="vp-middle"></span><span class="vp-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside id="sidebar" class="vp-sidebar" vp-sidebar><!----><ul class="vp-sidebar-links"></ul><!----></aside><!--[--><main id="main-content" class="vp-page"><!--[--><!----><!----><nav class="vp-breadcrumb disable"></nav><div class="vp-page-title"><h1><!---->礦坑系列 ── Indirect through null pointer</h1><div class="page-info"><span class="page-author-info" aria-label="Author🖊" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon" name="author"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><a class="page-author-item" href="https://mes0903.github.io" target="_blank" rel="noopener noreferrer">Mes</a></span><span property="author" content="Mes"></span></span><!----><span class="page-date-info" aria-label="Writing Date📅" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon" name="calendar"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span data-allow-mismatch="text">August 12, 2023</span><meta property="datePublished" content="2023-08-12T00:00:00.000Z"></span><!----><span class="page-reading-time-info" aria-label="Reading Time⌛" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon" name="timer"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>About 12 min</span><meta property="timeRequired" content="PT12M"></span><span class="page-category-info" aria-label="Category🌈" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon category-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="category icon" name="category"><path d="M148.41 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H148.41c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.311-40.31zM147.556 553.478H429.73c22.263 0 40.311 18.048 40.311 40.31v282.176c0 22.263-18.048 40.312-40.31 40.312H147.555c-22.263 0-40.311-18.049-40.311-40.312V593.79c0-22.263 18.048-40.311 40.31-40.311zM593.927 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H593.927c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.31-40.31zM730.22 920.502H623.926c-40.925 0-74.22-33.388-74.22-74.425V623.992c0-41.038 33.387-74.424 74.425-74.424h222.085c41.038 0 74.424 33.226 74.424 74.067v114.233c0 10.244-8.304 18.548-18.547 18.548s-18.548-8.304-18.548-18.548V623.635c0-20.388-16.746-36.974-37.33-36.974H624.13c-20.585 0-37.331 16.747-37.331 37.33v222.086c0 20.585 16.654 37.331 37.126 37.331H730.22c10.243 0 18.547 8.304 18.547 18.547 0 10.244-8.304 18.547-18.547 18.547z"></path></svg><!--[--><span class="page-category-item color5 clickable" role="navigation">C++ Miner</span><!--]--><meta property="articleSection" content="C++ Miner"></span><span class="page-tag-info" aria-label="Tag🏷" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon tag-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="tag icon" name="tag"><path d="M939.902 458.563L910.17 144.567c-1.507-16.272-14.465-29.13-30.737-30.737L565.438 84.098h-.402c-3.215 0-5.726 1.005-7.634 2.913l-470.39 470.39a10.004 10.004 0 000 14.164l365.423 365.424c1.909 1.908 4.42 2.913 7.132 2.913s5.223-1.005 7.132-2.913l470.39-470.39c2.01-2.11 3.014-5.023 2.813-8.036zm-240.067-72.121c-35.458 0-64.286-28.828-64.286-64.286s28.828-64.285 64.286-64.285 64.286 28.828 64.286 64.285-28.829 64.286-64.286 64.286z"></path></svg><!--[--><span class="page-tag-item color1 clickable" role="navigation">C++ Miner-BlackMagic</span><!--]--><meta property="keywords" content="C++ Miner-BlackMagic"></span></div><hr></div><div class="vp-toc-placeholder"><aside id="toc" vp-toc><!----><!--[--><div class="vp-toc-header">On This Page<button type="button" class="print-button" title="Print"><svg xmlns="http://www.w3.org/2000/svg" class="icon print-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="print icon" name="print"><path d="M819.2 364.8h-44.8V128c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v236.8h-44.8C145.067 364.8 96 413.867 96 473.6v192c0 59.733 49.067 108.8 108.8 108.8h44.8V896c0 17.067 14.933 32 32 32h460.8c17.067 0 32-14.933 32-32V774.4h44.8c59.733 0 108.8-49.067 108.8-108.8v-192c0-59.733-49.067-108.8-108.8-108.8zM313.6 160h396.8v204.8H313.6V160zm396.8 704H313.6V620.8h396.8V864zM864 665.6c0 25.6-19.2 44.8-44.8 44.8h-44.8V588.8c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v121.6h-44.8c-25.6 0-44.8-19.2-44.8-44.8v-192c0-25.6 19.2-44.8 44.8-44.8h614.4c25.6 0 44.8 19.2 44.8 44.8v192z"></path></svg></button><div class="arrow end"></div></div><div class="vp-toc-wrapper"><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#pointer-arithmetic-的路徑">pointer arithmetic 的路徑</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#與-的路徑">* 與 -&gt; 的路徑</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#結論">結論</a></li><!----><!--]--></ul><div class="vp-toc-marker" style="top:-1.7rem;"></div></div><!--]--><!----></aside></div><!----><div class="theme-hope-content" vp-content><h1><!----></h1><p>礦坑系列首頁：<strong><a href="https://github.com/Mes0903/Cpp-Miner/tree/hackmd" class="redlink">首頁</a></strong></p><p>hackmd 版首頁：<strong><a href="https://hackmd.io/@Mes/Cpp_Miner/https%3A%2F%2Fhackmd.io%2F%40Mes%2FPreface" class="redlink">首頁</a></strong></p><h1 id="前言" tabindex="-1"><a class="header-anchor" href="#前言"><span>前言</span></a></h1><p>事情起於 jserv 的講義裡面有個 <code>&amp;((data*)0)-&gt;c)</code> 這樣的操作，作用是求 <code>c</code> 在 <code>data</code> 這個 struct 中的偏移量，但那個 <code>0</code> 實在是讓我覺得很不順眼，為了確定他到底是不是 UB，我翻了一個多禮拜的 standard 與 committee paper，甚至翻了 CWG issue 和 Standard Defect Report，才總算是有個結果 (翻到快吐了)</p><p>雖然問題本身莫名其妙變得很複雜，但其實結論很簡單：因為 standard 沒有要求，所以是 UB</p><p>不過在翻的過程，找到了一些有趣的討論，所以這邊就記錄一下為何 <code>&amp;((data*)0)-&gt;c)</code> 是 UB，與為何 <em>Indirect through null pointer</em> 會有是不是 UB 的疑慮</p><p>註：本文將以 n4861(C++20) 內的定義為主<br> 註2：本文討論的內容都假設 class type 為 standard layout type，非 standard layout type 不在本文討論範圍內，相關內容詳見 <a href="https://en.cppreference.com/w/cpp/types/offsetof?fbclid=IwAR0qW2nZ1MX3ZPlmDXROTMNxB4fY_1Ba637-j_6ew_RAU2-T7HyshlQ-QQs#:~:text=offsetof%20cannot%20be%20implemented%20in,specified%20by%20C%20DR%20496" target="_blank" rel="noopener noreferrer">offsetof</a></p><h1 id="implicit-undefined-behavior" tabindex="-1"><a class="header-anchor" href="#implicit-undefined-behavior"><span>Implicit Undefined Behavior?</span></a></h1><p>Implicit Undefined Behavior 是口語的說法，不是標準內的用語，其表達的意義就如前言所說：</p><blockquote><p>standard 沒有要求的東西歸為 UB</p></blockquote><p>C 和 C++ 都有於 standard 內列下這個規則，下面是 C 與 C++ 對於 undefined behavior 的定義：</p><blockquote><p><a href="https://cigix.me/c17#3.4.3.p1" target="_blank" rel="noopener noreferrer">c17#3.4.3.p1</a>: behavior, upon use of a nonportable or erroneous program construct or of erroneous data, for which this <span class="yellow">International Standard imposes no requirements</span></p></blockquote><blockquote><p><a href="https://timsong-cpp.github.io/cppwp/n4861/defns.undefined#sentence-1" target="_blank" rel="noopener noreferrer">n4861(defns.undefined)</a>：behavior for which this document imposes no requirements</p></blockquote><p>也就是說，如果我們要說一個 behavior 是 UB，那麼推導的過程是：</p><ol><li>找出該 behavior 在標準內的定義，若其有在標準內被定義為 well-defined、undefined、unspecified 或 implementation-defined behavior，那它就屬於標準內定義的那類</li><li>否則，其為 undefined behavior</li></ol><p>一般來說會使用第一點，畢竟 C++ 明確定義的東西很多，不過這次使用的是第二點</p><p>某種程度上這類 UB 屬於 open issue，很多的 issue 都圍繞這類行為在做討論</p><p>另外，在實作上，<em>&quot;Technically UB but it’ll always do what you expect&quot;</em> 的狀況也是有的</p><h1 id="問題討論" tabindex="-1"><a class="header-anchor" href="#問題討論"><span>問題討論</span></a></h1><p>對於 <code>&amp;((T*)NULL)-&gt;member</code> 這個行為，重點在於中間的 <code>((T*)NULL)-&gt;member</code></p><p>要推出這段 code 是 UB，常見的說法有三個路徑：</p><ol><li>pointer arithmetic 的路徑</li><li>standard 內對於 <code>*</code> 與 <code>-&gt;</code> operator 操作定義的路徑</li><li>找不到所以 UB (Implicit Undefined Behavior)</li></ol><p>看了非常多篇的 stackoverflow，整理出了這三條，都有人用</p><p>我們先看看前兩條，試著找出標準內能套用到這個 behavior 上的定義</p><h3 id="pointer-arithmetic-的路徑" tabindex="-1"><a class="header-anchor" href="#pointer-arithmetic-的路徑"><span>pointer arithmetic 的路徑</span></a></h3><p>我們先談一下 pointer arithmetic 的 UB 行為，看以下的例子：</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> i </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> *</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">p </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> &amp;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">i;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">p </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">+=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    // p = &amp;i[1]; okay, well-defined</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> *</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">p2 </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> NULL</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">p2 </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">+=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    // p2 = &amp;NULL[1]; invalid, NULL is not an object</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p><a href="https://port70.net/~nsz/c/c11/n1570.html#6.5.6p7" target="_blank" rel="noopener noreferrer">c17#6.5.6.p7</a>：For the purposes of these operators, a pointer to an object that is not an element of an array behaves the same as <span class="yellow">a pointer to the first element of an array of length one with the type of the object as its element type</span>.</p></blockquote><p>這裡說的是，在進行 pointer arithmetic 的時候，如果指標指向的東西不是 array 的 member，那麼指標的行為會和「指向長度為 1 的陣列的第一個元素的指標，其元素類型為指向的物件的類型」相同</p><p>換句話說，<code>&amp;( ((int*)0) + 1 )</code> 也是 UB</p><p>而 <code>-&gt;</code> 在 compiler 的實作上使用了 <code>pointer arithmetic</code> 的操作來完成，<span class="yellow">然而這並沒有在標準內被 specified</span>，因此以語言面來說，這個理由並不能套用到 <code>((T*)NULL)-&gt;member</code> 上</p><p>但對於實務層面來說，這是一個說明它 <em>invalid</em> 的好原因，至少我個人覺得它比第二個理由好</p><h3 id="與-的路徑" tabindex="-1"><a class="header-anchor" href="#與-的路徑"><span><code>*</code> 與 <code>-&gt;</code> 的路徑</span></a></h3><p>C++ 中有個條款明確定義了 <code>-&gt;</code> 與 <code>*</code> 在語言上的等價性：</p><blockquote><p><a href="https://timsong-cpp.github.io/cppwp/n4861/expr.ref#2" target="_blank" rel="noopener noreferrer">n4861(expr.ref#2)</a>：For the first option (dot) the first expression shall be a glvalue. For the second option (arrow) the first expression shall be a prvalue having pointer type. <span class="yellow">The expression <code>E1-&gt;E2</code> is converted to the equivalent form <code>(*(E1)).E2</code></span>; the remainder of [expr.ref] will address only the first option (dot).</p></blockquote><p>因此我們可以將 <code>((T*)NULL)-&gt;member</code> 寫成 <code>(*((T*)NULL)).member</code></p><p>再來 <code>*</code> 的條款說：</p><blockquote><p><a href="https://timsong-cpp.github.io/cppwp/n4861/expr.unary.op#1.sentence-1" target="_blank" rel="noopener noreferrer">n4861(expr.unary.op#1)</a>：The unary <code>*</code> operator performs indirection: the expression to which it is applied shall be a pointer to an object type, or a pointer to a function type and the result is an <span class="yellow">lvalue referring to the object or function to which the expression points</span>.</p></blockquote><p>而 <code>NULL</code> 不是 object 也不是 function，所以 <code>*NULL</code> 不在標準要求內，為 UB</p><p><span class="yellow">但在 C 的標準中並沒有定義 <code>-&gt;</code> 與 <code>*</code> 的等價性，所以這條是只有 C++ 能走的路線</span></p><h3 id="結論" tabindex="-1"><a class="header-anchor" href="#結論"><span>結論</span></a></h3><p>剛剛說有三條路線</p><p>對於 C，前兩個都不通，標準中也沒有特別定義此行為，因此為 Implicit Undefined Behavior</p><p>對於 C++，你可以用第二條，如果覺得第二條不該套用在這個情況，那就定義為 Implicit Undefined Behavior</p><p>總而言之，雖然 <code>((T*)NULL)-&gt;member</code> 沒有直接在標準中被列為 UB，但一定有條路線是可以推出它是 UB 的，所以此 behavior 為 UB 是確定的，但原因則有許多可能</p><p>然而原則上來說我們仍希望 UB 可以被 explicit specified，畢竟像這樣可能有多種原因的例子並不好，可能會有一些衍生的 issue 出現，接下來就看看 C++ 中的例子 <a href="http://std.dkuug.dk/JTC1/SC22/WG21/docs/cwg_active.html#232" target="_blank" rel="noopener noreferrer">CWG issue #232</a></p><h1 id="indirect-through-null-pointer" tabindex="-1"><a class="header-anchor" href="#indirect-through-null-pointer"><span>Indirect through null pointer?</span></a></h1><p>去年 12 月，又有人在 CWG 的 github 發了 <a href="https://github.com/cplusplus/CWG/issues/198" target="_blank" rel="noopener noreferrer">issue</a> 問 <a href="http://std.dkuug.dk/JTC1/SC22/WG21/docs/cwg_active.html#232" target="_blank" rel="noopener noreferrer">CWG issue #232</a> 的結果，可見 <em>Indirect through null pointer</em> 為 UB 的原因時至今日都還未被完全解決</p><p>個人推測是因為在實務上不是那麼重要，但在 standard 中卻是類似於憲法的存在，所以雖然有 issue，但改起來麻煩，一開始改就會有一大串的東西被牽動，所以才從 2004 年到現在都還沒有個結論</p><p>這是 C++ committe 成員在那篇 <a href="https://github.com/cplusplus/CWG/issues/198" target="_blank" rel="noopener noreferrer">github issue</a> 留的原文：</p><blockquote><p>I would really welcome the suggested change here. This bit in the standard is a topic of recurring questions, and it always takes unfortunately long to explain that a null pointer does not point to an object, and hence dereferencing it is undefined behavior. We have a similar problem at [expr.ref]/6.2, where we say &quot;the expression designates the corresponding member subobject of the object designated by the first expression&quot;. There we don&#39;t (bother) say(ing) that if no object is designated, we are in the land of UB. That tends to take even longer to explain than the unary operator*. Even if we end up making mere operator* of a null pointer well-defined (See <a href="https://www.open-std.org/jtc1/sc22/wg21/docs/cwg_active.html#232" target="_blank" rel="noopener noreferrer">https://www.open-std.org/jtc1/sc22/wg21/docs/cwg_active.html#232</a>), in all likelihood we&#39;ll still (continue to) require that the LHS of an operator-&gt; must be non-null, and questions about that will continue. Unless we just clarify it, along the lines of what&#39;s been suggested here.</p></blockquote><p>在 stackoverflow 的討論中我看見了一個不錯的<a href="https://stackoverflow.com/questions/28482809/c-access-static-members-using-null-pointer/28483477" target="_blank" rel="noopener noreferrer">例子</a>，實務上是有可能遇到的，所以這邊先貼出來給你思考一下</p><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" data-title="cpp" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">#include</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &lt;iostream&gt;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">class</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> demo</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">public:</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  static</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> fun</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    std::cout </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;&lt;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;fun() is called</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">\n</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  }</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  static</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> a;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">};</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> demo::a </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 9</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> main</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">{</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  demo </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">d </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> nullptr</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">  d</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">fun</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  std::cout </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;&lt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> d</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">a</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  return</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>demo</code> 這個 class 裡面有一個 static member <code>a</code> 與一個 static member function <code>fun</code>，在 <code>main</code> 中有一個 pointer <code>d</code>，型態為 <code>demo*</code>，值為 <code>nullptr</code></p><p>問題來了，<code>d-&gt;fun()</code> 合法嗎?</p><h1 id="與" tabindex="-1"><a class="header-anchor" href="#與"><span><code>-&gt;</code> 與 <code>*</code></span></a></h1><p>前面有提到在 C++ 中 <code>-&gt;</code> 與 <code>*</code> 有這樣的等價關係：</p><blockquote><p><a href="https://timsong-cpp.github.io/cppwp/n4861/expr.ref#2" target="_blank" rel="noopener noreferrer">n4861(expr.ref#2)</a>：For the first option (dot) the first expression shall be a glvalue. For the second option (arrow) the first expression shall be a prvalue having pointer type. <span class="yellow">The expression <code>E1-&gt;E2</code> is converted to the equivalent form <code>(*(E1)).E2</code>;</span> the remainder of [expr.ref] will address only the first option (dot)</p></blockquote><p>這邊主要講了三件事：</p><ol><li><code>E1.E2</code> 的 <code>E1</code> 需要為 glvalue</li><li><code>E1-&gt;E2</code> 的 <code>E1</code> 需要為 prvalue</li><li><code>E1-&gt;E2</code> 等價為 <code>(*(E1)).E2</code></li></ol><p>所以接下來 <code>d-&gt;fun()</code> 我都會將其寫成 <code>(*d).fun()</code>，因此關鍵的部分在前面的 <code>(*d)</code>，因為這邊的 <code>d</code> 是個 <code>nullptr</code></p><p>這邊複習一下，expression 通常有兩個特性</p><ol><li>evaluated<br> 可能有 return 值，可能會被丟棄(如棄值表達式 Discarded-value expressions)</li><li>side-effect<br> 可能有，可能沒有</li></ol><p>這裡講得比較通俗好懂，原文是這樣的：</p><blockquote><p><a href="https://timsong-cpp.github.io/cppwp/n4861/expr#pre-1" target="_blank" rel="noopener noreferrer">n4861(expr#pre-1)</a>[ Note: [expr] defines the syntax, order of evaluation, and meaning of expressions. An expression is a sequence of operators and operands that specifies a computation. <span class="yellow">An expression can result in a value and can cause side effects.</span> — end note ]</p></blockquote><p>好，那我們看一下 <code>-&gt;</code> 的操作定義：</p><blockquote><p><a href="https://timsong-cpp.github.io/cppwp/n4861/expr.ref#1" target="_blank" rel="noopener noreferrer">n4861(expr.ref#1)</a>：A postfix expression followed by a dot . or an arrow -&gt;, optionally followed by the keyword template ([temp.names]), and then followed by an id-expression, is a postfix expression. <span class="yellow">The postfix expression before the dot or arrow is evaluated;</span> the result of that evaluation, together with the id-expression, determines the result of the entire postfix expression.</p></blockquote><p>這邊講的事很簡單，<code>E1-&gt;E2</code> 的 <code>E1</code> 會被 evaluate，所以 <code>d-&gt;fun()</code> 中的 <code>d</code> 會被 evaluated，換句話說，<code>(*d).fun()</code> 中的 <code>*d</code> 會被 evaluated</p><p><code>*d</code> 是 class member access expression，屬於棄值表達式，我們來看一下標準內有關棄值表達式的描述</p><blockquote><p><a href="https://timsong-cpp.github.io/cppwp/n4861/stmt.expr#1" target="_blank" rel="noopener noreferrer">n4861(stmt.expr#1)</a>：The expression is a discarded-value expression. <span class="yellow">All side effects from an expression statement are completed before the next statement is executed.</span> An expression statement with the expression missing is called a null statement. [ Note: Most statements are expression statements — usually assignments or function calls. A null statement is useful to carry a label just before the } of a compound statement and to supply a null body to an iteration statement such as a while statement. — end note ]</p></blockquote><p>因此如果 <code>*d;</code> 這個 statement 沒問題，那 <code>(*d).fun();</code> 自然沒問題，因此 <code>d-&gt;fun();</code> 沒問題</p><h1 id="標準自己用了-indirect-through-null-pointer" tabindex="-1"><a class="header-anchor" href="#標準自己用了-indirect-through-null-pointer"><span>標準自己用了 indirect through null pointer?</span></a></h1><p><a href="http://std.dkuug.dk/JTC1/SC22/WG21/docs/cwg_active.html#232" target="_blank" rel="noopener noreferrer">CWG issue#232</a> 是 2004 年發起的 issue，標題內容大大的就打了「Is indirection through a null pointer undefined behavior?」</p><p>討論的問題主要是說標準內有些舉例說這是 UB，但又有 well-defined 的例子，造成了歧異</p><p>我們現在就來看看這個 well-defined 的例子，要注意的是它被保留下來了，也就是說標準認定 indirection through null pointer 不全為 UB</p><p>這邊我一樣取 n4861 的內容，這與當年的 spec 內容不一樣，但沒關係重點沒變：</p><blockquote><p><a href="https://timsong-cpp.github.io/cppwp/n4861/expr.typeid#2" target="_blank" rel="noopener noreferrer">n4861(expr.typeid#2)</a>：When typeid is applied to a glvalue whose type is a polymorphic class type ([class.virtual]), the result refers to a std​<iconify-icon class="vp-icon" icon="fa6-solid:type_­info object representing the type of the most derived object ([intro.object]) (that is, the dynamic type) to which the glvalue refers. If the glvalue is &lt;span class by applying the unary * operator to a pointer and the pointer is a null pointer value&lt;/span&gt; ([basic.compound]), the typeid expression throws an exception ([except.throw]) of a type that would match a handler of type std​" height=" &quot;yellow&quot;&gt;obtained" sizing="height" style="--icon-size: &quot;yellow&quot;&gt;obtained;"></iconify-icon>​bad_­typeid exception ([bad.typeid]).</p></blockquote><p>我們看個例子：</p><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" data-title="cpp" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">#include</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &lt;iostream&gt;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">#include</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &lt;typeinfo&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> main</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">{</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  try</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    // Polymorphic type</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    class</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> A</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">      virtual</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> ~A</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">() {}</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    };</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#ABB2BF;">    typeid</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">((A </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">));</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  } </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">catch</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (std::bad_typeid) {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    std::cerr </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;&lt;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;bad_exception</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">\n</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>這個便是標準中給的 well-defined 例子，在這裡我們會 catch 住 <code>std::bad_typeid</code> 進而輸出 <code>bad_exception</code></p><p>這邊 <code>*((A*)0)</code> 為 lvalue expression，根據標準，在 <code>typeid</code> 中它會 evaluated 並導致 <code>std::bad_exception</code></p><blockquote><p><a href="https://timsong-cpp.github.io/cppwp/n4861/expr.typeid#3" target="_blank" rel="noopener noreferrer">n4868(expr.typeid#3)</a>：<span class="yellow">When typeid is applied to an expression other than a glvalue of a polymorphic class type, the result refers to a std​::​type_­info object representing the static type of the expression.</span> Lvalue-to-rvalue, array-to-pointer, and function-to-pointer conversions are not applied to the expression. If the expression is a prvalue, the temporary materialization conversion is applied. The expression is an unevaluated operand.</p></blockquote><h1 id="cwg-issue-232-的結論" tabindex="-1"><a class="header-anchor" href="#cwg-issue-232-的結論"><span>CWG issue#232 的結論</span></a></h1><p>最後這個 issue 討論的結果為</p><blockquote><p><code>p = 0; *p;</code> is <span class="yellow">not inherently an error</span>. An lvalue-to-rvalue conversion would give it undefined behavior.</p></blockquote><p>丟給了 lvalue-to-rvalue 轉換來處理，簡單來講就是沒有真正需要讀值的需求就沒事，用英文來說的話就是指 &quot;The identity of the object is not required&quot;，你不要直接寫 <code>*0</code> 這樣讓它一定要讀值就 ok</p><p>對此，<a href="https://www.open-std.org/jtc1/sc22/wg21/docs/cwg_closed.html?fbclid=IwAR0rntH_qBbUXw0Gh0evoaNY6mv04hXsOk-qkhDEc6axL2IUMGRZTP97GEU#315" target="_blank" rel="noopener noreferrer">CWG issue#315</a> 內明確表示了此處 <code>*d</code> 不會有 lvalue-to-rvalue conversion：</p><blockquote><p>Rationale (October 2003):<br> We agreed the example should be allowed. <code>p-&gt;f()</code> is rewritten as <code>(*p).f()</code> according to 7.6.1.5 [expr.ref]. <code>*p</code> is not an error when <code>p</code> is null unless the lvalue is converted to an rvalue (7.3.2 [conv.lval]), which it isn&#39;t here.</p></blockquote><p>然而時至今日，<a href="http://std.dkuug.dk/JTC1/SC22/WG21/docs/cwg_active.html#232" target="_blank" rel="noopener noreferrer">CWG issue#232</a> 的結果仍<span class="yellow">未被整入標準</span>，雖有<a href="http://arcoth.github.io/Proposals/EmptyLvalues.html" target="_blank" rel="noopener noreferrer">論文</a>在進行中，裡面更嚴謹的討論了除了這個 issue 以外的狀況(issue 內提出了一個稱為 <code>empty lvalue</code> 的概念，但還未加進標準)，但終究是進行中(那篇論文也有一段時間了，過了那麼久感覺是沒審過)，因此雖然我們知道應該要是可行的，但目前仍是 UB(一樣 by Implicit Undefined Behavior)</p><p>讓我們看看在 <a href="http://std.dkuug.dk/JTC1/SC22/WG21/docs/cwg_active.html#232" target="_blank" rel="noopener noreferrer">CWG issue#232</a> 中提到的 UB 例子：</p><blockquote><p><a href="https://timsong-cpp.github.io/cppwp/n4861/dcl.ref#5" target="_blank" rel="noopener noreferrer">n4861(dcl.ref#5)</a>：There shall be no references to references, no arrays of references, and no pointers to references. The declaration of a reference shall contain an initializer ([dcl.init.ref]) except when the declaration contains an explicit extern specifier ([dcl.stc]), is a class member ([class.mem]) declaration within a class definition, or is the declaration of a parameter or a return type ([dcl.fct]); see [basic.def]. A reference shall be initialized to refer to a valid object or function. [ Note: In particular, a null reference cannot exist in a well-defined program, because the only way to create such a reference would be to <span class="yellow">bind it to the “object” obtained by indirection through a null pointer, which causes undefined behavior.</span> As described in [class.bit], a reference cannot be bound directly to a bit-field. — end note ]</p></blockquote><p>另外，在 C++98 的 spec 中舉了 dereference null pointer 為 UB 的例子：</p><blockquote><p>n1146(intro.execution#4)：Certain other operations are described in this International Standard as undefined (<span class="yellow">for example, the effect of dereferencing the null pointer</span>). [Note: this International Standard imposes no requirements on the behavior of programs that contain undefined behavior. ]</p></blockquote><p>但這個例子在 2010 <a href="https://www.open-std.org/jtc1/sc22/wg21/docs/cwg_defects.html#1102" target="_blank" rel="noopener noreferrer">CWG issue#1102</a> 討論後<span class="yellow">被改掉了</span>：</p><blockquote><p><a href="https://timsong-cpp.github.io/cppwp/n3337/intro.execution#4" target="_blank" rel="noopener noreferrer">n3337(intro.execution#4)</a>：Certain other operations are described in this International Standard as undefined (for example, the effect of attempting to <span class="yellow">modify a const object</span>). [ Note: This International Standard imposes no requirements on the behavior of programs that contain undefined behavior. — end note ]</p></blockquote><p>issue#1102 中給的理由是</p><blockquote><p>There are core issues surrounding the undefined behavior of dereferencing a null pointer. It appears the intent is that dereferencing is well defined, but using the result of the dereference will yield undefined behavior. This topic is too confused to be the reference example of undefined behavior, or should be stated more precisely if it is to be retained.</p></blockquote><p>簡單來說就是這個問題還在討論中，不要用這個當例子</p><p>所以，雖然這是 2004 年就存在的問題，然而直到現在已經要出 C++26 了，這個問題都還沒解決XD</p><h1 id="參考連結" tabindex="-1"><a class="header-anchor" href="#參考連結"><span>參考連結</span></a></h1><ol><li><a href="https://stackoverflow.com/questions/43533262/dereference-null-is-not-always-ub" target="_blank" rel="noopener noreferrer">Dereference null is not always UB?</a></li><li><a href="https://stackoverflow.com/questions/28482809/c-access-static-members-using-null-pointer/28483477" target="_blank" rel="noopener noreferrer">c++ access static members using null pointer</a></li><li><a href="http://std.dkuug.dk/JTC1/SC22/WG21/docs/cwg_active.html#232" target="_blank" rel="noopener noreferrer">CWG issue#232</a></li><li><a href="http://std.dkuug.dk/JTC1/SC22/WG21/docs/cwg_closed.html#315" target="_blank" rel="noopener noreferrer">CWG issue#315</a></li><li><a href="http://std.dkuug.dk/JTC1/SC22/WG21/docs/cwg_active.html#342" target="_blank" rel="noopener noreferrer">CWG issue#342</a></li><li><a href="https://www.open-std.org/jtc1/sc22/wg21/docs/cwg_defects.html#1102" target="_blank" rel="noopener noreferrer">CWG issue#1102</a></li><li><a href="https://stackoverflow.com/questions/64167285/what-are-the-rules-for-a-valid-dereferencing-of-a-null-pointer" target="_blank" rel="noopener noreferrer">What are the rules for a valid dereferencing of a null pointer?</a></li><li><a href="https://www.open-std.org/jtc1/sc22/wg14/www/docs/n2248.pdf" target="_blank" rel="noopener noreferrer">Implicit Undefined Behavior in C</a></li><li><a href="https://www.open-std.org/jtc1/sc22/wg14/www/docs/dr_017.html" target="_blank" rel="noopener noreferrer">X3J11 DR#017</a></li><li><a href="https://stackoverflow.com/questions/76894031/is-dereference-null-pointer-ub-in-c20" target="_blank" rel="noopener noreferrer">Is dereference null pointer UB in C++20?</a></li><li><a href="https://github.com/cplusplus/CWG/issues/198" target="_blank" rel="noopener noreferrer">CWG232 [expr.unary.op] p1 should explicitly specify the behavior if the expression does not refer to the object or function </a></li></ol></div><!----><footer class="vp-page-meta"><div class="vp-meta-item edit-link"><a class="auto-link external-link vp-meta-label" href="https://github.com/Mes0903/Mes0903.github.io/edit/main/src/Cpp-Miner/Miner_BlackMagic/Indirect_through_null_pointer/README.md" aria-label="Edit this page" rel="noopener noreferrer" target="_blank" iconsizing="both"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon edit-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="edit icon" name="edit"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></svg><!--]-->Edit this page<!----></a></div><div class="vp-meta-item git-info"><!----><!----></div></footer><!----><!----><!----><!--]--></main><!--]--><footer class="vp-footer-wrapper" vp-footer><div class="vp-footer">The content on this site is all CC-BY-SA, or MIT/GPLv3+ dual license for code.</div><div class="vp-copyright">Copyright © 2025 Mes </div></footer></div><!--]--><!--]--><!--[--><!----><!--[--><!--]--><!--]--><!--]--></div>
    <script type="module" src="/assets/app-BcP8o8U4.js" defer></script>
  </body>
</html>
