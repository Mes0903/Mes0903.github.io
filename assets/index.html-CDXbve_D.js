import{_ as h}from"./plugin-vue_export-helper-DlAUqK2U.js";import{e as k,f as s,h as l,g as t,i as e,j as a,r as p,o as d}from"./app-DjPugh5v.js";const r={};function A(c,i){const n=p("center");return d(),k("div",null,[i[9]||(i[9]=s("h1",{id:"pe-file-format",tabindex:"-1"},[s("a",{class:"header-anchor",href:"#pe-file-format"},[s("span",null,"PE file format")])],-1)),i[10]||(i[10]=s("h1",{id:"前言",tabindex:"-1"},[s("a",{class:"header-anchor",href:"#前言"},[s("span",null,"前言")])],-1)),i[11]||(i[11]=s("p",null,"PE 是 Portable Executable 的縮寫，它是根據 UNIX 系統的 COFF 來設計的，在 Windows 下所有的可執行文件都是 PE File，像是 EXE、DLL、SYS、OCX 等等",-1)),i[12]||(i[12]=s("p",null,"PE File 內部的格式是規定好的，也就是所謂的 PE file format，大致可以分為兩部分，Header 與 Section：",-1)),l(n,null,{default:e(()=>i[0]||(i[0]=[s("img",{src:"https://github.com/Mes0903/MesBlog/blob/vuepress-theme-hope/src/security/PE_file_format/image/header_section.png?raw=true"},null,-1),s("p",null,[a("(圖片"),s("a",{href:"https://www.researchgate.net/figure/Portable-executable-file-format_fig6_338355873",target:"_blank",rel:"noopener noreferrer"},"連結"),a(")")],-1)])),_:1}),i[13]||(i[13]=t(`<br><p>Header 是用來管理 PE file 的，包含了一些執行檔的重要資訊，而 Section 則包含了程式碼、常量、資料和圖片資源等等</p><p>為了後續講解，這邊用 asm 寫了一個很簡單的 Windows Program，執行檔名為 demo.exe：</p><div class="language-asm line-numbers-mode" data-highlighter="shiki" data-ext="asm" data-title="asm" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">; demo.asm</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    .</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">386</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    .model flat, stdcall</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    option </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">casemap:</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">none</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">include \\masm32\\include\\windows.</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">inc</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">include \\masm32\\include\\kernel32.</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">inc</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">include \\masm32\\include\\user32.</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">inc</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">include \\masm32\\include\\masm32.</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">inc</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">includelib \\masm32\\lib\\kernel32.lib</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">includelib \\masm32\\lib\\user32.lib</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">includelib \\masm32\\lib\\masm32.lib</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">    .data</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">szCaptions  </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">db</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> &#39;hello&#39;, </span><span style="--shiki-light:#986801;--shiki-dark:#C678DD;">0</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">szText  </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">db</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> &#39;Hello World!&#39;, </span><span style="--shiki-light:#986801;--shiki-dark:#C678DD;">0</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    .code</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">start:</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">    push</span><span style="--shiki-light:#986801;--shiki-dark:#C678DD;"> 0</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">    lea</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> eax</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, szCaptions</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">    push</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> eax</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">    lea</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> eax</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, szText</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">    push</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> eax</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">    push</span><span style="--shiki-light:#986801;--shiki-dark:#C678DD;"> 0</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">    call</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> MessageBox</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">    push</span><span style="--shiki-light:#986801;--shiki-dark:#C678DD;"> 0</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">    call</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> ExitProcess</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    end start</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>由於我是用 masm 組譯，所以指令就下</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">\\masm32\\bin\\ml</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> /c</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> /Zd</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> /coff</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> demo.asm</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">\\masm32\\bin\\Link</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> /SUBSYSTEM:CONSOLE</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> demo.obj</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>我們可以用 PE-bear 這個軟體來看 PE file 的內容，這是我用 PEbear 將 demo.exe 開起來的樣貌：</p>`,7)),l(n,null,{default:e(()=>i[1]||(i[1]=[s("img",{src:"https://github.com/Mes0903/MesBlog/blob/vuepress-theme-hope/src/security/PE_file_format/image/PE_bear.png?raw=true"},null,-1)])),_:1}),i[14]||(i[14]=s("br",null,null,-1)),i[15]||(i[15]=s("p",null,"可以看見 demo.exe 由 DOS Header, DOS stub, NT Headers, Section Headers 與幾個 Sections 組成，那接下來就會依序介紹這些東西",-1)),i[16]||(i[16]=s("h1",{id:"dos-header",tabindex:"-1"},[s("a",{class:"header-anchor",href:"#dos-header"},[s("span",null,"DOS Header")])],-1)),i[17]||(i[17]=s("p",null,"PE file 最一開始的部分是 Dos Header，PE-bear 可以幫我們把這段 binary：",-1)),l(n,null,{default:e(()=>i[2]||(i[2]=[s("img",{src:"https://github.com/Mes0903/MesBlog/blob/vuepress-theme-hope/src/security/PE_file_format/image/DOS_header1.png?raw=true"},null,-1)])),_:1}),i[18]||(i[18]=s("br",null,null,-1)),i[19]||(i[19]=s("p",null,"解析為這樣：",-1)),l(n,null,{default:e(()=>i[3]||(i[3]=[s("img",{src:"https://github.com/Mes0903/MesBlog/blob/vuepress-theme-hope/src/security/PE_file_format/image/DOS_header2.png?raw=true"},null,-1)])),_:1}),i[20]||(i[20]=t(`<br><p>DOS Header 是 PE File 中的起始位置，以前的功用是用來保持與 DOS 的兼容性與定位 NT Header，而現在的功用只剩下後者</p><p>DOS Header 是一個 C struct，在 <code>winnt.h</code> 中的定義如下：</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">typedef</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> struct</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> _IMAGE_DOS_HEADER {</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">      // DOS .EXE header</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  WORD   e_magic;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">                     // EXE 簽名 mz</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  WORD   e_cblp;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">                      // Bytes on last page of file</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  WORD   e_cp;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">                        // Pages in file</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  WORD   e_crlc;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">                      // Relocations</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  WORD   e_cparhdr;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">                   // Size of header in paragraphs</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  WORD   e_minalloc;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">                  // Minimum extra paragraphs needed</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  WORD   e_maxalloc;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">                  // Maximum extra paragraphs needed</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  WORD   e_ss;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">                        // Initial (relative) SS value</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  WORD   e_sp;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">                        // Initial SP value</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  WORD   e_csum;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">                      // Checksum</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  WORD   e_ip;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">                        // Initial IP value</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  WORD   e_cs;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">                        // Initial (relative) CS value</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  WORD   e_lfarlc;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">                    // File address of relocation table</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  WORD   e_ovno;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">                      // Overlay number</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  WORD   </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">e_res</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">4</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">];</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">                    // Reserved words</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  WORD   e_oemid;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">                     // OEM identifier (for e_oeminfo)</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  WORD   e_oeminfo;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">                   // OEM information; e_oemid specific</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  WORD   </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">e_res2</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">10</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">];</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">                  // Reserved words</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  LONG   e_lfanew;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">                    // NT Header 位址</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">} IMAGE_DOS_HEADER, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">PIMAGE_DOS_HEADER;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>它的大小為 <code>40h</code>(h 代表用十六進位表示)，其中 <code>WORD</code> 是 2bytes，<code>LONG</code> 是 4bytes。 我們關心的只有兩個成員：<code>e_magic</code> 與 <code>e_lfanew</code></p><p><code>e_magic</code> 是一個簽名，ASCII 的轉換結果為 <code>MZ</code>，所有的 PE file 都要以這個 <code>MZ</code> 開頭；而 <code>e_lfanew</code> 指向 NT Header 的位址。 其它的元素是在 DOS 環境下要使用的，在 Windows 下就無關</p><p>而 DOS Stub 也是在 DOS 環境下使用的，主要功能就是拿來報錯，這邊也就不詳細介紹</p><h1 id="nt-headers-pe-headers" tabindex="-1"><a class="header-anchor" href="#nt-headers-pe-headers"><span>NT Headers (PE Headers)</span></a></h1><p>NT Headers 也是一個 C struct，它在 <code>winnt.h</code> 的定義如下：</p><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" data-title="cpp" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">#ifdef</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> _WIN64</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">typedef</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> IMAGE_NT_HEADERS64                  IMAGE_NT_HEADERS;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">typedef</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> PIMAGE_NT_HEADERS64                 PIMAGE_NT_HEADERS;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">#else</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">typedef</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> IMAGE_NT_HEADERS32                  IMAGE_NT_HEADERS;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">typedef</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> PIMAGE_NT_HEADERS32                 PIMAGE_NT_HEADERS;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">#endif</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>其中的 <code>32</code> 與 <code>64</code> 就代表 32 位元和 64 位元，在編譯期的時候就會選擇好了</p><p>而 <code>IMAGE_NT_HEADERS64</code> 與 <code>IMAGE_NT_HEADERS32</code> 的差異也很小：</p><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" data-title="cpp" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">typedef</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> struct</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> _IMAGE_NT_HEADERS64</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    DWORD Signature;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"> // PE 簽名</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    IMAGE_FILE_HEADER FileHeader;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    IMAGE_OPTIONAL_HEADER64 OptionalHeader;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">} </span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">IMAGE_NT_HEADERS64</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">PIMAGE_NT_HEADERS64</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">typedef</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> struct</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> _IMAGE_NT_HEADERS</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    DWORD Signature;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    IMAGE_FILE_HEADER FileHeader;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    IMAGE_OPTIONAL_HEADER32 OptionalHeader;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">} </span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">IMAGE_NT_HEADERS32</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">PIMAGE_NT_HEADERS32</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以看見基本上一樣的，差異只在 Optional Header</p><p>第一個成員 <code>Signature</code> 是 <code>PE File</code> 的簽名，簽名為 <code>PE</code>，用 PE-bear 可以看見其 binary 為<br><code>00 00 45 50</code>(此 exe 為 little endian)</p>`,15)),l(n,null,{default:e(()=>i[4]||(i[4]=[s("img",{src:"https://github.com/Mes0903/MesBlog/blob/vuepress-theme-hope/src/security/PE_file_format/image/NT_header.png?raw=true"},null,-1)])),_:1}),i[21]||(i[21]=t(`<br><h2 id="fileheader" tabindex="-1"><a class="header-anchor" href="#fileheader"><span>FileHeader</span></a></h2><p>FileHeader 的定義如下：</p><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" data-title="cpp" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">typedef</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> struct</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> _IMAGE_FILE_HEADER</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  WORD    Machine;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">                       // 平台，intel 386 為 0x014c，intel 64 為 0x0200</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  WORD    NumberOfSections;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">              // Section 數量，最多 96 個字節</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  DWORD   TimeDateStamp;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">                 // 編譯日期</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  DWORD   PointerToSymbolTable;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  DWORD   NumberOfSymbols;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  WORD    SizeOfOptionalHeader;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">          // OptionalHeader 大小, 32 位通常為 E0，64 位通常為 F0</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  WORD    Characteristics;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">               // 檔案屬性，EXE 通常為 010f，DLL 通常為 210e</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">} </span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">IMAGE_FILE_HEADER</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">PIMAGE_FILE_HEADER</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>Machine</code> 表示平台，可能得值如下：</p><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" data-title="cpp" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">#define</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> IMAGE_FILE_MACHINE_UNKNOWN</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">           0</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">#define</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> IMAGE_FILE_MACHINE_TARGET_HOST</span><span style="--shiki-light:#986801;--shiki-dark:#E06C75;">       0x</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">0001</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  // Useful for indicating we want to interact with the host and not a WoW guest.</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">#define</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> IMAGE_FILE_MACHINE_I386</span><span style="--shiki-light:#986801;--shiki-dark:#E06C75;">              0x</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">014c</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  // Intel 386.</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">#define</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> IMAGE_FILE_MACHINE_R3000</span><span style="--shiki-light:#986801;--shiki-dark:#E06C75;">             0x</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">0162</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  // MIPS little-endian, 0x160 big-endian</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">#define</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> IMAGE_FILE_MACHINE_R4000</span><span style="--shiki-light:#986801;--shiki-dark:#E06C75;">             0x</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">0166</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  // MIPS little-endian</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">#define</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> IMAGE_FILE_MACHINE_R10000</span><span style="--shiki-light:#986801;--shiki-dark:#E06C75;">            0x</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">0168</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  // MIPS little-endian</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">#define</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> IMAGE_FILE_MACHINE_WCEMIPSV2</span><span style="--shiki-light:#986801;--shiki-dark:#E06C75;">         0x</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">0169</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  // MIPS little-endian WCE v2</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">#define</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> IMAGE_FILE_MACHINE_ALPHA</span><span style="--shiki-light:#986801;--shiki-dark:#E06C75;">             0x</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">0184</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  // Alpha_AXP</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">#define</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> IMAGE_FILE_MACHINE_SH3</span><span style="--shiki-light:#986801;--shiki-dark:#E06C75;">               0x</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">01a2</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  // SH3 little-endian</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">#define</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> IMAGE_FILE_MACHINE_SH3DSP</span><span style="--shiki-light:#986801;--shiki-dark:#E06C75;">            0x</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">01a3</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">#define</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> IMAGE_FILE_MACHINE_SH3E</span><span style="--shiki-light:#986801;--shiki-dark:#E06C75;">              0x</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">01a4</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  // SH3E little-endian</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">#define</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> IMAGE_FILE_MACHINE_SH4</span><span style="--shiki-light:#986801;--shiki-dark:#E06C75;">               0x</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">01a6</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  // SH4 little-endian</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">#define</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> IMAGE_FILE_MACHINE_SH5</span><span style="--shiki-light:#986801;--shiki-dark:#E06C75;">               0x</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">01a8</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  // SH5</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">#define</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> IMAGE_FILE_MACHINE_ARM</span><span style="--shiki-light:#986801;--shiki-dark:#E06C75;">               0x</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">01c0</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  // ARM Little-Endian</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">#define</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> IMAGE_FILE_MACHINE_THUMB</span><span style="--shiki-light:#986801;--shiki-dark:#E06C75;">             0x</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">01c2</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  // ARM Thumb/Thumb-2 Little-Endian</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">#define</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> IMAGE_FILE_MACHINE_ARMNT</span><span style="--shiki-light:#986801;--shiki-dark:#E06C75;">             0x</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">01c4</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  // ARM Thumb-2 Little-Endian</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">#define</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> IMAGE_FILE_MACHINE_AM33</span><span style="--shiki-light:#986801;--shiki-dark:#E06C75;">              0x</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">01d3</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">#define</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> IMAGE_FILE_MACHINE_POWERPC</span><span style="--shiki-light:#986801;--shiki-dark:#E06C75;">           0x</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">01F0</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  // IBM PowerPC Little-Endian</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">#define</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> IMAGE_FILE_MACHINE_POWERPCFP</span><span style="--shiki-light:#986801;--shiki-dark:#E06C75;">         0x</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">01f1</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">#define</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> IMAGE_FILE_MACHINE_IA64</span><span style="--shiki-light:#986801;--shiki-dark:#E06C75;">              0x</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">0200</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  // Intel 64</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">#define</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> IMAGE_FILE_MACHINE_MIPS16</span><span style="--shiki-light:#986801;--shiki-dark:#E06C75;">            0x</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">0266</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  // MIPS</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">#define</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> IMAGE_FILE_MACHINE_ALPHA64</span><span style="--shiki-light:#986801;--shiki-dark:#E06C75;">           0x</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">0284</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  // ALPHA64</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">#define</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> IMAGE_FILE_MACHINE_MIPSFPU</span><span style="--shiki-light:#986801;--shiki-dark:#E06C75;">           0x</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">0366</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  // MIPS</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">#define</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> IMAGE_FILE_MACHINE_MIPSFPU16</span><span style="--shiki-light:#986801;--shiki-dark:#E06C75;">         0x</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">0466</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  // MIPS</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">#define</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> IMAGE_FILE_MACHINE_AXP64</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">             IMAGE_FILE_MACHINE_ALPHA64</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">#define</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> IMAGE_FILE_MACHINE_TRICORE</span><span style="--shiki-light:#986801;--shiki-dark:#E06C75;">           0x</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">0520</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  // Infineon</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">#define</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> IMAGE_FILE_MACHINE_CEF</span><span style="--shiki-light:#986801;--shiki-dark:#E06C75;">               0x</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">0CEF</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">#define</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> IMAGE_FILE_MACHINE_EBC</span><span style="--shiki-light:#986801;--shiki-dark:#E06C75;">               0x</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">0EBC</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  // EFI Byte Code</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">#define</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> IMAGE_FILE_MACHINE_AMD64</span><span style="--shiki-light:#986801;--shiki-dark:#E06C75;">             0x</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">8664</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  // AMD64 (K8)</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">#define</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> IMAGE_FILE_MACHINE_M32R</span><span style="--shiki-light:#986801;--shiki-dark:#E06C75;">              0x</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">9041</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  // M32R little-endian</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">#define</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> IMAGE_FILE_MACHINE_ARM64</span><span style="--shiki-light:#986801;--shiki-dark:#E06C75;">             0x</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">AA64</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  // ARM64 Little-Endian</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">#define</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> IMAGE_FILE_MACHINE_CEE</span><span style="--shiki-light:#986801;--shiki-dark:#E06C75;">               0x</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">C0EE</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>以 demo.exe 來說，其值為 <code>014c</code></p>`,7)),l(n,null,{default:e(()=>i[5]||(i[5]=[s("img",{src:"https://github.com/Mes0903/MesBlog/blob/vuepress-theme-hope/src/security/PE_file_format/image/File_header1.png?raw=true"},null,-1)])),_:1}),i[22]||(i[22]=t(`<br><p>這很長一串，用到的時候再查就好</p><p><code>TimeDateStamp</code> 表示編譯日期；<code>SizeOfOptionalHeader</code> 表示 Optional Header 的大小，32 bit 的電腦通常為 <code>0xE0</code>，64 bit 通常為 <code>0xF0</code></p><p>Characteristics 記錄了這個檔案的屬性，會是以下這些值去做 <code>or</code> 運算：</p><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" data-title="cpp" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">#define</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> IMAGE_FILE_RELOCS_STRIPPED</span><span style="--shiki-light:#986801;--shiki-dark:#E06C75;">           0x</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">0001</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  // Relocation info stripped from file.</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">#define</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> IMAGE_FILE_EXECUTABLE_IMAGE</span><span style="--shiki-light:#986801;--shiki-dark:#E06C75;">          0x</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">0002</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  // File is executable  (i.e. no unresolved external references).</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">#define</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> IMAGE_FILE_LINE_NUMS_STRIPPED</span><span style="--shiki-light:#986801;--shiki-dark:#E06C75;">        0x</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">0004</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  // Line nunbers stripped from file.</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">#define</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> IMAGE_FILE_LOCAL_SYMS_STRIPPED</span><span style="--shiki-light:#986801;--shiki-dark:#E06C75;">       0x</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">0008</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  // Local symbols stripped from file.</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">#define</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> IMAGE_FILE_AGGRESIVE_WS_TRIM</span><span style="--shiki-light:#986801;--shiki-dark:#E06C75;">         0x</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">0010</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  // Aggressively trim working set</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">#define</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> IMAGE_FILE_LARGE_ADDRESS_AWARE</span><span style="--shiki-light:#986801;--shiki-dark:#E06C75;">       0x</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">0020</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  // App can handle &gt;2gb addresses</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">#define</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> IMAGE_FILE_BYTES_REVERSED_LO</span><span style="--shiki-light:#986801;--shiki-dark:#E06C75;">         0x</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">0080</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  // Bytes of machine word are reversed.</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">#define</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> IMAGE_FILE_32BIT_MACHINE</span><span style="--shiki-light:#986801;--shiki-dark:#E06C75;">             0x</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">0100</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  // 32 bit word machine.</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">#define</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> IMAGE_FILE_DEBUG_STRIPPED</span><span style="--shiki-light:#986801;--shiki-dark:#E06C75;">            0x</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">0200</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  // Debugging info stripped from file in .DBG file</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">#define</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> IMAGE_FILE_REMOVABLE_RUN_FROM_SWAP</span><span style="--shiki-light:#986801;--shiki-dark:#E06C75;">   0x</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">0400</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  // If Image is on removable media, copy and run from the swap file.</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">#define</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> IMAGE_FILE_NET_RUN_FROM_SWAP</span><span style="--shiki-light:#986801;--shiki-dark:#E06C75;">         0x</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">0800</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  // If Image is on Net, copy and run from the swap file.</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">#define</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> IMAGE_FILE_SYSTEM</span><span style="--shiki-light:#986801;--shiki-dark:#E06C75;">                    0x</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1000</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  // System File.</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">#define</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> IMAGE_FILE_DLL</span><span style="--shiki-light:#986801;--shiki-dark:#E06C75;">                       0x</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">2000</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  // File is a DLL.</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">#define</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> IMAGE_FILE_UP_SYSTEM_ONLY</span><span style="--shiki-light:#986801;--shiki-dark:#E06C75;">            0x</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">4000</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  // File should only be run on a UP machine</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">#define</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> IMAGE_FILE_BYTES_REVERSED_HI</span><span style="--shiki-light:#986801;--shiki-dark:#E06C75;">         0x</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">8000</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  // Bytes of machine word are reversed.</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>以 demo.exe 來說其值為 <code>0x010f</code>，因此是 1, 2, 4, 8, 100 做 <code>or</code> 運算</p>`,6)),l(n,null,{default:e(()=>i[6]||(i[6]=[s("img",{src:"https://github.com/Mes0903/MesBlog/blob/vuepress-theme-hope/src/security/PE_file_format/image/File_header2.png?raw=true"},null,-1)])),_:1}),i[23]||(i[23]=t(`<br><h2 id="optional-header-可選頭" tabindex="-1"><a class="header-anchor" href="#optional-header-可選頭"><span>Optional Header (可選頭)</span></a></h2><p>Optional Header 雖然有 <code>Optional</code> 這詞在裡面，但它是一定要有的，其定義如下：</p><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" data-title="cpp" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">typedef</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> struct</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> _IMAGE_OPTIONAL_HEADER</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    //</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    // Standard fields.</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    //</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    WORD    Magic;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">                       // 簽名， 107h = ROM Image， 10Bh = EXE Image，20Bh = PE32+</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    BYTE    MajorLinkerVersion;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">          // Linker 版本號</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    BYTE    MinorLinkerVersion;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    DWORD   SizeOfCode;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">                  // 所有含有程式碼的 Section 大小</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    DWORD   SizeOfInitializedData;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">       // 所有含有初始化數據的 Section 大小</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    DWORD   SizeOfUninitializedData;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">     // 所有含位未始化數據的 Section 大小(不佔用檔案空間，載入記憶體後才會分配空間)</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    DWORD   AddressOfEntryPoint;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">         // Process 執行入口 RVA(距離 PE 載入後地址的距離，病毒和加密程式都會修改其值，從而獲得程式的控制權；對於 DLL，如果沒有入口函式，那麼就是 0；對於驅動其值為初始化的函式地址)</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    DWORD   BaseOfCode;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">                  // 程式碼的 Section 的起始 RVA(通常跟在 NT Header 後)</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    DWORD   BaseOfData;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">                  // 數據的 Section 的起始 RVA </span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    //</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    // NT additional fields.</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    //</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    DWORD   ImageBase;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">                   // Process 建議的載入地址</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    DWORD   SectionAlignment;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">            // 記憶體中的 Section 對齊值</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    DWORD   FileAlignment;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">               // 檔案中的 Section 對齊值</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    WORD    MajorOperatingSystemVersion;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"> // OS 版本號</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    WORD    MinorOperatingSystemVersion;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    WORD    MajorImageVersion;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">           // PE 版本號</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    WORD    MinorImageVersion;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    WORD    MajorSubsystemVersion;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">       // 需要的 Subsystem 版本號</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    WORD    MinorSubsystemVersion;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    DWORD   Win32VersionValue;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">           // 未使用，必須為 0</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    DWORD   SizeOfImage;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">                 // 記憶體中整個 PE 檔案的 image 大小</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    DWORD   SizeOfHeaders;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">               // 所有的 Header 與 Section Header 加起來的大小</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    DWORD   CheckSum;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">                    // 檢驗值，一般文件為 0，DLL 和 SYS 則會有其設定的值</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    WORD    Subsystem;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">                   // 檔案子系統</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    WORD    DllCharacteristics;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">          // DLL 檔案特性</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    DWORD   SizeOfStackReserve;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">          // 初始化時保留的 stack 大小 (預設 1M)</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    DWORD   SizeOfStackCommit;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">           // 初始化時實際給予的 stack 大小 (預設 4K)</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    DWORD   SizeOfHeapReserve;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">           // 初始化時保留的 Heap 大小 (預設 1M)</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    DWORD   SizeOfHeapCommit;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">            // 初始化時實際給予的 Heap 大小 (預設 4K)</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    DWORD   LoaderFlags;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">                 // 加載旗幟，通常是 0</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    DWORD   NumberOfRvaAndSizes;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">         // 數據目錄的數量</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    IMAGE_DATA_DIRECTORY </span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">DataDirectory</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[IMAGE_NUMBEROF_DIRECTORY_ENTRIES];</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"> // 數據目錄的陣列</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">} </span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">IMAGE_OPTIONAL_HEADER32</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">PIMAGE_OPTIONAL_HEADER32</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h1 id="section-headers-區段頭" tabindex="-1"><a class="header-anchor" href="#section-headers-區段頭"><span>Section Headers (區段頭)</span></a></h1><p>Section Header 會記錄每個 Section 的資訊，定義如下：</p><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" data-title="cpp" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">#define</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> IMAGE_SIZEOF_SHORT_NAME</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">              8</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">typedef</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> struct</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> _IMAGE_SECTION_HEADER</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    BYTE    </span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">Name</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[IMAGE_SIZEOF_SHORT_NAME];</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">       // 區段名，如 .text 或 .data</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    union</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">            DWORD   PhysicalAddress;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">            DWORD   VirtualSize;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">                 // 區段大小</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    } Misc;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    DWORD   VirtualAddress;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">                      // 區段的位移 (RVA)</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    DWORD   SizeOfRawData;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">                       // Section 在檔案中對齊後的大小</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    DWORD   PointerToRawData;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">                    // Section 在檔案中的偏移量 (FOA)</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    DWORD   PointerToRelocations;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">                // 在 OBJ 文件中使用</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    DWORD   PointerToLinenumbers;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">                // 行號表的位置(debug 時使用)</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    WORD    NumberOfRelocations;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">                 // 在 OBJ 文件中使用</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    WORD    NumberOfLinenumbers;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">                 // 行號表中行號的數量</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    DWORD   Characteristics;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">                     // Section 屬性</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">} </span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">IMAGE_SECTION_HEADER</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">PIMAGE_SECTION_HEADER</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">#define</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> IMAGE_SIZEOF_SECTION_HEADER</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">          40</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>每個 Section Header 會指向對應的 Section，像是這樣</p>`,8)),l(n,null,{default:e(()=>i[7]||(i[7]=[s("img",{src:"https://github.com/Mes0903/MesBlog/blob/vuepress-theme-hope/src/security/PE_file_format/image/Section_header.png?raw=true"},null,-1),s("p",null,[a("(圖片"),s("a",{href:"https://tech-zealots.com/malware-analysis/pe-portable-executable-structure-malware-analysis-part-2/",target:"_blank",rel:"noopener noreferrer"},"連結"),a(")")],-1)])),_:1}),i[24]||(i[24]=t('<br><p>Section Header 只負責記錄對應 Section 的重要屬性，像是 Section 的名字，大小，RVA 等等</p><h1 id="section-區段" tabindex="-1"><a class="header-anchor" href="#section-區段"><span>Section(區段)</span></a></h1><p>在 Headers 之後接的就是各個 Section，像是大家熟悉的 <code>.text</code>、<code>.data</code> 等等都是個 Section</p><p><code>.text</code> 通常會是第一個 Section，是你可執行程式碼所在的位置，執行檔的進入點通常也會在這裡</p><p><code>.data</code> 段則是放你的數據，像是我們 <code>std::cout &lt;&lt; &quot;Hello&quot;;</code>，那麼 <code>&quot;Hello&quot;</code> 這個資料就會放在 <code>.data</code> 裡面</p><p>其他還有很多，上面的圖也可以大概看到，有興趣的可以查一下，這邊就不贅述</p><h1 id="va、rva、foa" tabindex="-1"><a class="header-anchor" href="#va、rva、foa"><span>VA、RVA、FOA</span></a></h1><p>而一個 PE 在硬碟與在記憶體中的偏移量會有所不同，這邊會有三個名詞先介紹一下：</p><ul><li>VA: 虛擬位址(Virtual Address)，指 PE 檔案載入「記憶體」後的位址</li><li>RVA: 相對虛擬位址(Relative Virtual Address)，是 PE 檔案中資料、Section 等在「記憶體」中的偏移量</li><li>FOA: 文件偏移位址(File Offset Address)，是 PE 檔案中資料、Section 等在「硬碟」中的偏移量</li></ul><p>我們看張圖來解釋：</p>',11)),l(n,null,{default:e(()=>i[8]||(i[8]=[s("img",{src:"https://github.com/Mes0903/MesBlog/blob/vuepress-theme-hope/src/security/PE_file_format/image/RVA.png?raw=true"},null,-1)])),_:1}),i[25]||(i[25]=s("br",null,null,-1)),i[26]||(i[26]=s("p",null,[a("這邊假設每個 Section 的大小都小於 Alignment 的大小，所以一個 Section 的大小就是一個 Alignment 的大小。x86 下 FileAlignment 通常是 "),s("code",null,"0x200"),a("，也就是 512 bytes，這也是一個硬碟扇區的大小。而 x86 下 SectionAlignment 通常是 "),s("code",null,"0x1000")],-1)),i[27]||(i[27]=s("p",null,[a("而 Section 開始的位址為 Base 的位址加上其偏移量，在硬碟中，Base 的位址為 0，偏移量則是 "),s("code",null,"PointerToRawData"),a(" 決定的，也就是 FOA")],-1)),i[28]||(i[28]=s("p",null,[a("在記憶體中，Base 的位址為 Imagebase 的位址，然而這是對第一個載入記憶體的 PE 而言，當 Imagebase 處已經有 PE 載入時，OS 會介入調整載入位址，因此我們常說 Imagebase 為「建議載入」位址，而記憶體中 Section 的偏移量則是 "),s("code",null,"VirtualAddress"),a(" 的數值，也就是 RVA，RVA 的數值加上 Base 的位址則是 Section 在記憶體上的位址，稱為 VA，因此 VA = RVA + Imagebase")],-1))])}const o=h(r,[["render",A],["__file","index.html.vue"]]),E=JSON.parse(`{"path":"/security/PE_file_format/","title":"PE file format","lang":"en-US","frontmatter":{"title":"PE file format","date":"2023-01-09T00:00:00.000Z","tag":"security","category":"security","description":"PE file format 前言 PE 是 Portable Executable 的縮寫，它是根據 UNIX 系統的 COFF 來設計的，在 Windows 下所有的可執行文件都是 PE File，像是 EXE、DLL、SYS、OCX 等等 PE File 內部的格式是規定好的，也就是所謂的 PE file format，大致可以分為兩部分，Hea...","head":[["meta",{"property":"og:url","content":"https://mes0903.github.io/security/PE_file_format/"}],["meta",{"property":"og:site_name","content":"Mes's Blog"}],["meta",{"property":"og:title","content":"PE file format"}],["meta",{"property":"og:description","content":"PE file format 前言 PE 是 Portable Executable 的縮寫，它是根據 UNIX 系統的 COFF 來設計的，在 Windows 下所有的可執行文件都是 PE File，像是 EXE、DLL、SYS、OCX 等等 PE File 內部的格式是規定好的，也就是所謂的 PE file format，大致可以分為兩部分，Hea..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"en-US"}],["meta",{"property":"og:updated_time","content":"2025-02-22T20:43:16.000Z"}],["meta",{"property":"article:tag","content":"security"}],["meta",{"property":"article:published_time","content":"2023-01-09T00:00:00.000Z"}],["meta",{"property":"article:modified_time","content":"2025-02-22T20:43:16.000Z"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"PE file format\\",\\"image\\":[\\"\\"],\\"datePublished\\":\\"2023-01-09T00:00:00.000Z\\",\\"dateModified\\":\\"2025-02-22T20:43:16.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"Mes\\",\\"url\\":\\"https://mes0903.github.io\\"}]}"]]},"git":{"createdTime":1740149490000,"updatedTime":1740256996000,"contributors":[{"name":"Mes","username":"Mes","email":"mes900903@gmail.com","commits":5,"url":"https://github.com/Mes"}]},"readingTime":{"minutes":8.78,"words":2633},"filePathRelative":"security/PE_file_format/README.md","localizedDate":"January 9, 2023","excerpt":"","autoDesc":true}`);export{o as comp,E as data};
